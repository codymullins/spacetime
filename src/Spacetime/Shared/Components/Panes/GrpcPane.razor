@using Spacetime.Core
@using Spacetime.Core.Services
@using Spacetime.Core.gRPC
@using Spacetime.Shared.Components.Display
@using Spacetime.Shared.Icons
@using Spacetime.Core.Infrastructure;
@using Spacetime.Shared.Components.Typography
@using Spacetime.Shared.Components.Display.Table

@inject IGrpcExplorer GrpcExplorer
@inject RequestService RequestService

<div class="p-2">
    <h2>Protos</h2>
    <div class="shadow-sm overflow-hidden my-8">
    <table class="border-collapse table-auto w-full text-sm">
        <thead>
            <tr>
                <TableHeader>Service</TableHeader>
                <TableHeader>Method</TableHeader>
            </tr>
        </thead>
        <tbody class="bg-white dark:bg-zinc-800">
            <tr>
                <TableCell>greet.Greeter1</TableCell>
                <TableCell>sayHello1</TableCell>
            </tr>
            <tr>
                <TableCell>greet.Greeter2</TableCell>
                <TableCell>sayHello2</TableCell>
            </tr>
            <tr>
                <TableCell>greet.Greeter3</TableCell>
                <TableCell>sayHello3</TableCell>
            </tr>
        </tbody>
    </table>
    </div>
    <h2>Add Proto</h2>
    <div class="mb-2">
        <strong>Proto Import Path</strong>
        <input class="px-4 py-2 w-5/6 border border-zinc-700 bg-zinc-800" type="text" @bind="Request.ImportPath" @onblur="Save" />
    </div>
    <div class="mb-2">
        <strong>Proto File Name</strong>
        <input class="px-4 py-2 w-5/6 border border-zinc-700 bg-zinc-800" type="text" @bind="Request.ProtoFile" @onblur="Save" />
    </div>
    <div class="mb-2">
        <button @onclick="ValidateGrpc"
                class="border border-zinc-700 hover:border-zinc-600 hover:bg-zinc-600 px-2 py-1 rounded-l-sm mr-0 bg-green-600">
            Validate Proto
        </button>
    </div>
    @if (GrpcExploreResult != null)
    {
        <div>
            @foreach (var s in GrpcExploreResult.Services)
            {
                <div class="text-bold mb-2"><SmallCaps>Service</SmallCaps> @s.Name</div>
                @foreach (var method in s.Methods)
                {
                    <ListItem OnActionCallback="@(() => {})" OnClickCallback="@(() => {})">
                        <Prefix><SmallCaps>Method</SmallCaps></Prefix>
                        <Title>@method.Name</Title>
                        <ActionTemplate><DotsVerticalIcon /></ActionTemplate>
                    </ListItem>
                }
            }
        </div>
    }

</div>

@code {
    [Parameter]
    public SpacetimeRequest Request { get; set; }
    public GrpcExploreResult GrpcExploreResult { get; set; }

    private void ValidateGrpc()
    {
        GrpcExploreResult = GrpcExplorer.GetExplorer(Request.ImportPath, Request.ProtoFile);
    }

    private async Task Save()
    {
        // todo: figure out how to better handle these common things
        // e.g., bubble these up, use a "redux" pattern, etc.
        try
        {
            await RequestService.UpdateRequest(Request);
        }
        catch (Exception ex)
        {
            // todo: handle this? :-)
        }
    }
}
